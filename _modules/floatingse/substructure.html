
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>floatingse.substructure &#8212; FloatingSE 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/nrel.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FloatingSE 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for floatingse.substructure</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">openmdao.api</span> <span class="k">import</span> <span class="n">Component</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">cumtrapz</span>

<span class="kn">from</span> <span class="nn">commonse</span> <span class="k">import</span> <span class="n">gravity</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">DirectionVector</span><span class="p">,</span> <span class="n">NFREQ</span>
<span class="kn">from</span> <span class="nn">commonse.utilities</span> <span class="k">import</span> <span class="n">assembleI</span><span class="p">,</span> <span class="n">unassembleI</span>
<span class="kn">from</span> <span class="nn">.map_mooring</span> <span class="k">import</span> <span class="n">NLINES_MAX</span>
        
<div class="viewcode-block" id="SubstructureGeometry"><a class="viewcode-back" href="../../package.html#floatingse.substructure.SubstructureGeometry">[docs]</a><span class="k">class</span> <span class="nc">SubstructureGeometry</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OpenMDAO Component class for substructure geometry for floating offshore wind turbines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nFull</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SubstructureGeometry</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Design variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_d_full&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;outer radius at each section node bottom to top (length = nsection + 1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_d_full&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;outer radius at each section node bottom to top (length = nsection + 1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_z_nodes&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-coordinates of section nodes (length = nsection+1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_freeboard&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Length of column above water line&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_draft&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Length of column below water line&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_z_nodes&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-coordinates of section nodes (length = nsection+1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;fairlead_location&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Fractional length from column bottom to top for mooring line attachment&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;fairlead_offset_from_shell&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;fairlead offset from shell&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;radius_to_offset_column&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Distance from main column centerpoint to offset column centerpoint&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Number of offset columns evenly spaced around main column&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;tower_d_full&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;outer radius at each section node bottom to top (length = nsection + 1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;Rhub&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;rotor hub radius&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;max_survival_heel&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;max heel angle for turbine survival&#39;</span><span class="p">)</span>
        
        <span class="c1"># Output constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;fairlead&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Depth below water line for mooring line attachment&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;fairlead_radius&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Outer spar radius at fairlead depth (point of mooring attachment)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;main_offset_spacing&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Radius of main and offset columns relative to spacing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;tower_transition_buffer&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Buffer between substructure main and tower main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;nacelle_transition_buffer&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Buffer between tower top and nacelle main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;offset_freeboard_heel_margin&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin so offset column does not submerge during max heel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;offset_draft_heel_margin&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin so offset column does not leave water during max heel&#39;</span><span class="p">)</span>

        
        <span class="c1"># Derivatives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fd&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;central&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;check_form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;central&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;step_calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;relative&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
        
    <span class="k">def</span> <span class="nf">solve_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">,</span> <span class="n">resids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets nodal points and sectional centers of mass in z-coordinate system with z=0 at the waterline.</span>
<span class="sd">        Nodal points are the beginning and end points of each section.</span>
<span class="sd">        Nodes and sections start at bottom and move upwards.</span>
<span class="sd">        </span>
<span class="sd">        INPUTS:</span>
<span class="sd">        ----------</span>
<span class="sd">        params   : dictionary of input parameters</span>
<span class="sd">        unknowns : dictionary of output parameters</span>
<span class="sd">        </span>
<span class="sd">        OUTPUTS  : none (all unknown dictionary values set)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">ncolumns</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">])</span>
        <span class="n">R_od_main</span>       <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_d_full&#39;</span><span class="p">]</span>
        <span class="n">R_od_offset</span>    <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_d_full&#39;</span><span class="p">]</span>
        <span class="n">R_semi</span>          <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;radius_to_offset_column&#39;</span><span class="p">]</span>
        <span class="n">R_tower</span>         <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;tower_d_full&#39;</span><span class="p">]</span>
        <span class="n">R_hub</span>           <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Rhub&#39;</span><span class="p">]</span>
        
        <span class="n">z_nodes_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_z_nodes&#39;</span><span class="p">]</span>
        <span class="n">z_nodes_main</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_z_nodes&#39;</span><span class="p">]</span>
        
        <span class="n">location</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fairlead_location&#39;</span><span class="p">]</span>
        <span class="n">fair_off</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fairlead_offset_from_shell&#39;</span><span class="p">]</span>
        <span class="n">off_freeboard</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_freeboard&#39;</span><span class="p">]</span>
        <span class="n">off_draft</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_draft&#39;</span><span class="p">]</span>
        <span class="n">max_heel</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;max_survival_heel&#39;</span><span class="p">]</span>

        <span class="c1"># Set spacing constraint</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;main_offset_spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_semi</span> <span class="o">-</span> <span class="n">R_od_main</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">R_od_offset</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Determine location and radius at mooring connection point (fairlead)</span>
        <span class="k">if</span> <span class="n">ncolumns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">z_fairlead</span> <span class="o">=</span> <span class="n">location</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_nodes_offset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_nodes_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">z_nodes_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;fairlead_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_semi</span> <span class="o">+</span> <span class="n">fair_off</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z_fairlead</span><span class="p">,</span> <span class="n">z_nodes_offset</span><span class="p">,</span> <span class="n">R_od_offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_fairlead</span> <span class="o">=</span> <span class="n">location</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_nodes_main</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_nodes_main</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">z_nodes_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;fairlead_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fair_off</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z_fairlead</span><span class="p">,</span> <span class="n">z_nodes_main</span><span class="p">,</span> <span class="n">R_od_main</span><span class="p">)</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;fairlead&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">z_fairlead</span> <span class="c1"># Fairlead defined as positive below waterline</span>
        
        <span class="c1"># Constrain spar top to be at least greater than tower main</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;tower_transition_buffer&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">R_od_main</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R_tower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;nacelle_transition_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_hub</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">R_tower</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Guessing at 6m size for nacelle</span>

        <span class="c1"># Make sure semi columns don&#39;t get submerged</span>
        <span class="n">heel_deflect</span> <span class="o">=</span> <span class="n">R_semi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">max_heel</span><span class="p">))</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;offset_freeboard_heel_margin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_freeboard</span> <span class="o">-</span> <span class="n">heel_deflect</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;offset_draft_heel_margin&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">off_draft</span> <span class="o">-</span> <span class="n">heel_deflect</span></div>



<div class="viewcode-block" id="Substructure"><a class="viewcode-back" href="../../package.html#floatingse.substructure.Substructure">[docs]</a><span class="k">class</span> <span class="nc">Substructure</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nFull</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Substructure</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;water_density&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg/m**3&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;density of water&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;wave_period_range_low&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Lower bound of typical ocean wavve period&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;wave_period_range_high&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Upper bound of typical ocean wavve period&#39;</span><span class="p">)</span>

        <span class="c1"># From other components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;operational_heel&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Maximum angle of heel allowable&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Mass of mooring lines&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_moments_of_inertia&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass moment of inertia of mooring system about fairlead-centerline point [xx yy zz xy xz yz]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_neutral_load&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NLINES_MAX</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-force of mooring lines on structure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_surge_restoring_force&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Restoring force from mooring system after surge motion&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_pitch_restoring_force&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NLINES_MAX</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Restoring force from mooring system after pitch motion&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_cost&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Cost of mooring system&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;mooring_stiffness&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N/m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Linearized stiffness matrix of mooring system at neutral (no offset) conditions.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;fairlead&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Depth below water for mooring line attachment&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;fairlead_radius&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Outer spar radius at fairlead depth (point of mooring attachment)&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Number of offset columns evenly spaced around main column&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;radius_to_offset_column&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Distance from main column centerpoint to offset column centerpoint&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_Iwaterplane&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**4&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Second moment of area of waterplane cross-section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_Awaterplane&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Area of waterplane cross-section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_cost&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Cost of spar structure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass of main column by section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_freeboard&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Length of spar above water line&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_center_of_buoyancy&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-position of center of column buoyancy force&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_center_of_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-position of center of column mass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_moments_of_inertia&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass moment of inertia of column about main [xx yy zz xy xz yz]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;main_added_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Diagonal of added mass matrix- masses are first 3 entries, moments are last 3&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_Iwaterplane&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**4&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Second moment of area of waterplane cross-section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_Awaterplane&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Area of waterplane cross-section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_cost&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Cost of spar structure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass of offset column by section&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_center_of_buoyancy&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-position of center of column buoyancy force&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_center_of_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-position of center of column mass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_moments_of_inertia&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass moment of inertia of column about main [xx yy zz xy xz yz]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;offset_added_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Diagonal of added mass matrix- masses are first 3 entries, moments are last 3&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;tower_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Mass of tower&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;tower_I_base&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Moments about tower main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;tower_z_full&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-coordinates of section nodes (length = nsection+1)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;rna_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Mass of RNA&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;rna_cg&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Location of RNA center of mass relative to tower top&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;rna_I&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Moments about turbine main&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;water_ballast_zpts_vector&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-points of potential ballast mass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;water_ballast_radius_vector&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nFull</span><span class="p">,)),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Inner radius of potential ballast mass&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;structural_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Mass of whole turbine except for mooring lines&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;structure_center_of_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;xyz-position of center of gravity of whole turbine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;structural_frequencies&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NFREQ</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;z_center_of_buoyancy&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;z-position of center of gravity (x,y = 0,0)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;total_displacement&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**3&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Total volume of water displaced by floating turbine (except for mooring lines)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;total_force&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Net forces on turbine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;total_moment&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N*m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Moments on whole turbine&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;pontoon_cost&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Cost of pontoon elements and connecting truss&#39;</span><span class="p">)</span>

        
        <span class="c1"># Outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;substructure_moments_of_inertia&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass moment of inertia of substructure (no tower or rna or mooring) [xx yy zz xy xz yz]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;total_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;total mass of spar and moorings&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;total_cost&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;total cost of spar and moorings&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;metacentric_height&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;measure of static overturning stability&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;buoyancy_to_gravity&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;static stability margin based on position of centers of gravity and buoyancy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;offset_force_ratio&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;total surge force divided by restoring force&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;heel_moment_ratio&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;total pitch moment divided by restoring moment&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;Iwaterplane_system&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**4&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Second moment of area of waterplane cross-section for whole structure&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;center_of_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;xyz-position of center of gravity (x,y = 0,0)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;variable_ballast_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Amount of variable water ballast&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;variable_ballast_center_of_mass&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Center of mass for variable ballast&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;variable_ballast_moments_of_inertia&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg*m**2&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mass moment of inertia of variable ballast [xx yy zz xy xz yz]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;variable_ballast_height&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;height of water ballast to balance spar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;variable_ballast_height_ratio&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Ratio of water ballast height to available height&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;mass_matrix&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Summary mass matrix of structure (minus pontoons)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;added_mass_matrix&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Summary hydrodynamic added mass matrix of structure (minus pontoons)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;hydrostatic_stiffness&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;N/m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Summary hydrostatic stiffness of structure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;rigid_body_periods&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Natural periods of oscillation in 6 DOF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;period_margin_low&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin between natural periods and 2 second wave period&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;period_margin_high&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin between natural periods and 20 second wave period&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;modal_margin_low&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NFREQ</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin between structural modes and 2 second wave period&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;modal_margin_high&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NFREQ</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Margin between structural modes and 20 second wave period&#39;</span><span class="p">)</span>
        
        
        <span class="c1"># Derivatives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fd&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;central&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;check_form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;central&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;step_calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;relative&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deriv_options</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
        
    <span class="k">def</span> <span class="nf">solve_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">,</span> <span class="n">resids</span><span class="p">):</span>
        <span class="c1"># TODO: Get centerlines right- in sparGeometry?</span>
        <span class="c1"># Determine ballast and cg of system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>
        
        <span class="c1"># Determine stability, metacentric height from waterplane profile, displaced volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_stability</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>

        <span class="c1"># Compute natural periods of osciallation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_rigid_body_periods</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>
        
        <span class="c1"># Check margins of natural and eigenfrequencies against waves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_frequency_margins</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>
        
        <span class="c1"># Sum all costs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_costs</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">m_struct</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;structural_mass&#39;</span><span class="p">]</span>
        <span class="n">Fz_mooring</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_neutral_load&#39;</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">m_mooring</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_mass&#39;</span><span class="p">]</span>
        
        <span class="n">V_system</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;total_displacement&#39;</span><span class="p">]</span>

        <span class="n">cg_struct</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;structure_center_of_mass&#39;</span><span class="p">]</span>
        
        <span class="n">z_water_data</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_ballast_zpts_vector&#39;</span><span class="p">]</span>
        <span class="n">r_water_data</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_ballast_radius_vector&#39;</span><span class="p">]</span>
        <span class="n">rhoWater</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_density&#39;</span><span class="p">]</span>
        
        <span class="c1"># SEMI TODO: Make water_ballast in main only?  columns too?  How to apportion?</span>

        <span class="c1"># Make sure total mass of system with variable water ballast balances against displaced volume</span>
        <span class="c1"># Water ballast should be buried in m_column</span>
        <span class="n">m_water</span>  <span class="o">=</span> <span class="n">V_system</span><span class="o">*</span><span class="n">rhoWater</span> <span class="o">-</span> <span class="p">(</span><span class="n">m_struct</span> <span class="o">+</span> <span class="n">Fz_mooring</span><span class="o">/</span><span class="n">gravity</span><span class="p">)</span>
        <span class="n">m_system</span> <span class="o">=</span> <span class="n">m_struct</span> <span class="o">+</span> <span class="n">m_water</span>

        <span class="c1"># Output substructure total turbine mass</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;total_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_struct</span> <span class="o">+</span> <span class="n">m_mooring</span>

        <span class="c1"># Find height given interpolant functions from columns</span>
        <span class="n">m_water_data</span> <span class="o">=</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">r_water_data</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_water_data</span><span class="p">)</span>
        <span class="n">m_water_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">m_water_data</span><span class="p">]</span> <span class="c1">#cumtrapz has length-1</span>
        
        <span class="k">if</span> <span class="n">m_water_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m_water</span><span class="p">:</span>
            <span class="c1"># Don&#39;t have enough space, so max out variable balast here and constraints will catch this</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">z_water_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">m_water</span> <span class="o">/</span> <span class="n">m_water_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">m_water</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">z_water_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">m_water</span><span class="p">,</span> <span class="n">m_water_data</span><span class="p">,</span> <span class="n">z_water_data</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">h_water</span> <span class="o">=</span> <span class="n">z_end</span> <span class="o">-</span> <span class="n">z_water_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_mass&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">m_water</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">h_water</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_height_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">h_water</span> <span class="o">/</span> <span class="p">(</span><span class="n">z_water_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_water_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Find cg of whole system</span>
        <span class="c1"># First find cg of water variable ballast by finding midpoint of mass sum</span>
        <span class="n">z_cg</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">coeff</span><span class="o">*</span><span class="n">m_water</span><span class="p">,</span> <span class="n">m_water_data</span><span class="p">,</span> <span class="n">z_water_data</span><span class="p">)</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;center_of_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_struct</span><span class="o">*</span><span class="n">cg_struct</span> <span class="o">+</span> <span class="n">m_water</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_cg</span><span class="p">])</span> <span class="o">/</span> <span class="n">m_system</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_center_of_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_cg</span>

        <span class="c1"># Integrate for moment of inertia of variable ballast</span>
        <span class="n">npts</span>  <span class="o">=</span> <span class="mf">1e2</span>
        <span class="n">z_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_water_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_end</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
        <span class="n">r_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z_int</span><span class="p">,</span> <span class="n">z_water_data</span><span class="p">,</span> <span class="n">r_water_data</span><span class="p">)</span>
        <span class="n">Izz</span>   <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">r_int</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">z_int</span><span class="p">)</span>
        <span class="n">Ixx</span>   <span class="o">=</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="n">r_int</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">r_int</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">z_int</span><span class="o">-</span><span class="n">z_cg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_int</span><span class="p">)</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_moments_of_inertia&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Ixx</span><span class="p">,</span> <span class="n">Ixx</span><span class="p">,</span> <span class="n">Izz</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        
    <span class="k">def</span> <span class="nf">compute_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">ncolumn</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">])</span>
        <span class="n">z_cb</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;z_center_of_buoyancy&#39;</span><span class="p">]</span>
        <span class="n">z_cg</span>            <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;center_of_mass&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V_system</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;total_displacement&#39;</span><span class="p">]</span>
        
        <span class="n">Iwater_main</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_Iwaterplane&#39;</span><span class="p">]</span>
        <span class="n">Iwater_column</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_Iwaterplane&#39;</span><span class="p">]</span>
        <span class="n">Awater_column</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_Awaterplane&#39;</span><span class="p">]</span>

        <span class="n">F_surge</span>         <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;total_force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">M_pitch</span>         <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;total_moment&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">F_restore</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_surge_restoring_force&#39;</span><span class="p">]</span>
        <span class="n">rhoWater</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_density&#39;</span><span class="p">]</span>
        <span class="n">R_semi</span>          <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;radius_to_offset_column&#39;</span><span class="p">]</span>

        <span class="n">F_restore_pitch</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_pitch_restoring_force&#39;</span><span class="p">]</span>
        <span class="n">z_fairlead</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fairlead&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">R_fairlead</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fairlead_radius&#39;</span><span class="p">]</span>
        <span class="n">oper_heel</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;operational_heel&#39;</span><span class="p">]</span>
        
        <span class="c1"># Compute the distance from the center of buoyancy to the metacentre (BM is naval architecture)</span>
        <span class="c1"># BM = Iw / V where V is the displacement volume (just computed)</span>
        <span class="c1"># Iw is the area moment of inertia (meters^4) of the water-plane cross section about the heel axis</span>
        <span class="c1"># For a spar, we assume this is just the I of a circle about x or y</span>
        <span class="c1"># See https://en.wikipedia.org/wiki/Metacentric_height</span>
        <span class="c1"># https://en.wikipedia.org/wiki/List_of_second_moments_of_area</span>
        <span class="c1"># and http://farside.ph.utexas.edu/teaching/336L/Fluidhtml/node30.html</span>

        <span class="c1"># Water plane area of all components with parallel axis theorem</span>
        <span class="n">Iwater_system</span> <span class="o">=</span> <span class="n">Iwater_main</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">R_semi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ncolumn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncolumn</span><span class="p">):</span>
            <span class="n">Iwater_system</span> <span class="o">+=</span> <span class="n">Iwater_column</span> <span class="o">+</span> <span class="n">Awater_column</span><span class="o">*</span><span class="n">radii</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;Iwaterplane_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Iwater_column</span>
            
        <span class="c1"># Measure static stability:</span>
        <span class="c1"># 1. Center of buoyancy should be above CG (difference should be positive)</span>
        <span class="c1"># 2. Metacentric height should be positive</span>
        <span class="n">buoyancy2metacentre_BM</span>          <span class="o">=</span> <span class="n">Iwater_system</span> <span class="o">/</span> <span class="n">V_system</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;buoyancy_to_gravity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_cg</span> <span class="o">-</span> <span class="n">z_cb</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;metacentric_height&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">buoyancy2metacentre_BM</span> <span class="o">-</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;buoyancy_to_gravity&#39;</span><span class="p">]</span>

        <span class="n">F_buoy</span>     <span class="o">=</span> <span class="n">V_system</span> <span class="o">*</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">gravity</span>
        <span class="n">M_restore</span>  <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;metacentric_height&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">oper_heel</span><span class="p">))</span> <span class="o">*</span> <span class="n">F_buoy</span> 

        <span class="c1"># Convert mooring restoring force after pitch to a restoring moment</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">F_restore_pitch</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">F_restore_pitch</span> <span class="o">=</span> <span class="n">F_restore_pitch</span><span class="p">[:</span><span class="n">nlines</span><span class="p">,:]</span>
        <span class="n">moorx</span>  <span class="o">=</span> <span class="n">R_fairlead</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nlines</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">moory</span>  <span class="o">=</span> <span class="n">R_fairlead</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nlines</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">r_moor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">moorx</span><span class="p">,</span> <span class="n">moory</span><span class="p">,</span> <span class="p">(</span><span class="n">z_fairlead</span> <span class="o">-</span> <span class="n">z_cg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">moorx</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
        <span class="n">Msum</span>   <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
            <span class="n">dvF</span>   <span class="o">=</span> <span class="n">DirectionVector</span><span class="o">.</span><span class="n">fromArray</span><span class="p">(</span><span class="n">F_restore_pitch</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
            <span class="n">dvR</span>   <span class="o">=</span> <span class="n">DirectionVector</span><span class="o">.</span><span class="n">fromArray</span><span class="p">(</span><span class="n">r_moor</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">.</span><span class="n">yawToHub</span><span class="p">(</span><span class="n">oper_heel</span><span class="p">)</span>
            <span class="n">M</span>     <span class="o">=</span> <span class="n">dvR</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">dvF</span><span class="p">)</span>
            <span class="n">Msum</span> <span class="o">+=</span> <span class="n">M</span><span class="o">.</span><span class="n">y</span>

        <span class="n">M_restore</span> <span class="o">+=</span> <span class="n">Msum</span>
        
        <span class="c1"># Comput heel angle, scaling overturning moment by defect of inflow velocity</span>
        <span class="c1"># TODO: Make this another load case in Frame3DD</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;heel_moment_ratio&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">oper_heel</span><span class="p">))</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">M_pitch</span> <span class="o">/</span> <span class="n">M_restore</span> <span class="p">)</span>

        <span class="c1"># Now compute offsets from the applied force</span>
        <span class="c1"># First use added mass (the mass of the water that must be displaced in movement)</span>
        <span class="c1"># http://www.iaea.org/inis/collection/NCLCollectionStore/_Public/09/411/9411273.pdf</span>
        <span class="c1">#mass_add_surge = rhoWater * np.pi * R_od.max() * draft</span>
        <span class="c1">#T_surge        = 2*np.pi*np.sqrt( (unknowns[&#39;total_mass&#39;]+mass_add_surge) / kstiff_horiz_mooring)</span>

        <span class="c1"># Compare restoring force from mooring to force of worst case spar displacement</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;offset_force_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F_surge</span> <span class="o">/</span> <span class="n">F_restore</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">compute_rigid_body_periods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">ncolumn</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">])</span>
        <span class="n">R_semi</span>          <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;radius_to_offset_column&#39;</span><span class="p">]</span>
        
        <span class="n">m_main</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_mass&#39;</span><span class="p">])</span>
        <span class="n">m_column</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_mass&#39;</span><span class="p">])</span>
        <span class="n">m_tower</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;tower_mass&#39;</span><span class="p">])</span>
        <span class="n">m_rna</span>           <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rna_mass&#39;</span><span class="p">]</span>
        <span class="n">m_mooring</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_mass&#39;</span><span class="p">]</span>
        <span class="n">m_total</span>         <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;total_mass&#39;</span><span class="p">]</span>
        <span class="n">m_water</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_mass&#39;</span><span class="p">])</span>
        <span class="n">m_a_main</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_added_mass&#39;</span><span class="p">]</span>
        <span class="n">m_a_column</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_added_mass&#39;</span><span class="p">]</span>
        
        <span class="n">rhoWater</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_density&#39;</span><span class="p">]</span>
        <span class="n">V_system</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;total_displacement&#39;</span><span class="p">]</span>
        <span class="n">h_metacenter</span>    <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;metacentric_height&#39;</span><span class="p">]</span>

        <span class="n">Awater_main</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_Awaterplane&#39;</span><span class="p">]</span>
        <span class="n">Awater_column</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_Awaterplane&#39;</span><span class="p">]</span>
        <span class="n">I_main</span>          <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_moments_of_inertia&#39;</span><span class="p">]</span>
        <span class="n">I_column</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_moments_of_inertia&#39;</span><span class="p">]</span>
        <span class="n">I_mooring</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_moments_of_inertia&#39;</span><span class="p">]</span>
        <span class="n">I_water</span>         <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_moments_of_inertia&#39;</span><span class="p">]</span>
        <span class="n">I_tower</span>         <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tower_I_base&#39;</span><span class="p">]</span>
        <span class="n">I_rna</span>           <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rna_I&#39;</span><span class="p">]</span>
        <span class="n">I_waterplane</span>    <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;Iwaterplane_system&#39;</span><span class="p">]</span>

        <span class="n">z_cg_main</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_center_of_mass&#39;</span><span class="p">]</span>
        <span class="n">z_cb_main</span>       <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_center_of_buoyancy&#39;</span><span class="p">]</span>
        <span class="n">z_cg_column</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_center_of_mass&#39;</span><span class="p">]</span>
        <span class="n">z_cb_column</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_center_of_buoyancy&#39;</span><span class="p">]</span>
        <span class="n">z_cb</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;z_center_of_buoyancy&#39;</span><span class="p">]</span>
        <span class="n">z_cg_water</span>      <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;variable_ballast_center_of_mass&#39;</span><span class="p">]</span>
        <span class="n">z_fairlead</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fairlead&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">r_cg</span>            <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;center_of_mass&#39;</span><span class="p">]</span>
        <span class="n">cg_rna</span>          <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rna_cg&#39;</span><span class="p">]</span>
        <span class="n">z_tower</span>         <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tower_z_full&#39;</span><span class="p">]</span>
        
        <span class="n">K_moor</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_stiffness&#39;</span><span class="p">]</span> <span class="p">)</span>

        
        <span class="c1"># Number of degrees of freedom</span>
        <span class="n">nDOF</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c1"># Compute elements on mass matrix diagonal</span>
        <span class="n">M_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDOF</span><span class="p">,))</span>
        <span class="c1"># Surge, sway, heave just use normal inertia (without mooring according to Senu)</span>
        <span class="n">M_mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_total</span> <span class="o">+</span> <span class="n">m_water</span> <span class="o">-</span> <span class="n">m_mooring</span>
        <span class="c1"># Add in moments of inertia of primary column</span>
        <span class="n">I_total</span> <span class="o">=</span> <span class="n">assembleI</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">I_main</span>  <span class="o">=</span> <span class="n">assembleI</span><span class="p">(</span> <span class="n">I_main</span> <span class="p">)</span>
        <span class="n">R</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_cg_main</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_cg</span>
        <span class="n">I_total</span> <span class="o">+=</span> <span class="n">I_main</span> <span class="o">+</span> <span class="n">m_main</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># Add up moments of intertia of other columns</span>
        <span class="n">radii_x</span>   <span class="o">=</span> <span class="n">R_semi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ncolumn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">radii_y</span>   <span class="o">=</span> <span class="n">R_semi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ncolumn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">I_column</span>  <span class="o">=</span> <span class="n">assembleI</span><span class="p">(</span> <span class="n">I_column</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncolumn</span><span class="p">):</span>
            <span class="n">R</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">radii_x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">radii_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">z_cg_column</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_cg</span>
            <span class="n">I_total</span> <span class="o">+=</span> <span class="n">I_column</span> <span class="o">+</span> <span class="n">m_column</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># Add in variable ballast</span>
        <span class="n">R</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_cg_water</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_cg</span>
        <span class="n">I_total</span>  <span class="o">+=</span> <span class="n">assembleI</span><span class="p">(</span><span class="n">I_water</span><span class="p">)</span> <span class="o">+</span> <span class="n">m_water</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        
        <span class="c1"># Save what we have so far as m_substructure &amp; I_substructure and move to its own CM</span>
        <span class="n">m_subs</span>    <span class="o">=</span>  <span class="n">m_main</span>           <span class="o">+</span> <span class="n">ncolumn</span><span class="o">*</span><span class="n">m_column</span>             <span class="o">+</span> <span class="n">m_water</span>
        <span class="n">z_cg_subs</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_main</span><span class="o">*</span><span class="n">z_cg_main</span> <span class="o">+</span> <span class="n">ncolumn</span><span class="o">*</span><span class="n">m_column</span><span class="o">*</span><span class="n">z_cg_column</span> <span class="o">+</span> <span class="n">m_water</span><span class="o">*</span><span class="n">z_cg_water</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_subs</span>
        <span class="n">R</span>              <span class="o">=</span> <span class="n">r_cg</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_cg_subs</span><span class="p">])</span>
        <span class="n">I_substructure</span> <span class="o">=</span> <span class="n">I_total</span> <span class="o">+</span> <span class="n">m_subs</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;substructure_moments_of_inertia&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unassembleI</span><span class="p">(</span> <span class="n">I_total</span> <span class="p">)</span>

        <span class="c1"># Now go back to the total</span>
        <span class="c1"># Add in mooring system- Not needed according to Senu</span>
        <span class="c1">#R         = np.array([0.0, 0.0, z_fairlead]) - r_cg</span>
        <span class="c1">#I_total  += assembleI(I_mooring) + m_mooring*(np.dot(R, R)*np.eye(3) - np.outer(R, R))</span>
        <span class="c1"># Add in tower</span>
        <span class="n">R</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_tower</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">-</span> <span class="n">r_cg</span>
        <span class="n">I_total</span>  <span class="o">+=</span> <span class="n">assembleI</span><span class="p">(</span><span class="n">I_tower</span><span class="p">)</span> <span class="o">+</span> <span class="n">m_tower</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># Add in RNA</span>
        <span class="n">R</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_tower</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">cg_rna</span> <span class="o">-</span> <span class="n">r_cg</span>
        <span class="n">I_total</span>  <span class="o">+=</span> <span class="n">assembleI</span><span class="p">(</span><span class="n">I_rna</span><span class="p">)</span> <span class="o">+</span> <span class="n">m_rna</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># Stuff moments of inertia into mass matrix</span>
        <span class="n">M_mat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">unassembleI</span><span class="p">(</span> <span class="n">I_total</span> <span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;mass_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_mat</span>
        
        <span class="c1"># Add up all added mass entries in a similar way</span>
        <span class="n">A_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDOF</span><span class="p">,))</span>
        <span class="c1"># Surge, sway, heave just use normal inertia</span>
        <span class="n">A_mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_a_main</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">ncolumn</span><span class="o">*</span><span class="n">m_a_column</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># Add up moments of inertia, move added mass moments from CofB to CofG</span>
        <span class="n">I_main</span>    <span class="o">=</span> <span class="n">assembleI</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">m_a_main</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>  <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="p">)</span>
        <span class="n">R</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z_cb_main</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_cg</span>
        <span class="n">I_total</span>   <span class="o">=</span> <span class="n">I_main</span> <span class="o">+</span> <span class="n">m_a_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># Add up added moments of intertia of all columns for other entries</span>
        <span class="n">I_column</span>  <span class="o">=</span> <span class="n">assembleI</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">m_a_column</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncolumn</span><span class="p">):</span>
            <span class="n">R</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">radii_x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">radii_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">z_cb_column</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_cg</span>
            <span class="n">I_total</span> <span class="o">+=</span> <span class="n">I_column</span> <span class="o">+</span> <span class="n">m_a_column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="n">A_mat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">unassembleI</span><span class="p">(</span> <span class="n">I_total</span> <span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;added_mass_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_mat</span>
        
        <span class="c1"># Hydrostatic stiffness has contributions in heave (K33) and roll/pitch (K44/55)</span>
        <span class="c1"># See DNV-RP-H103: Modeling and Analyis of Marine Operations</span>
        <span class="n">K_hydro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDOF</span><span class="p">,))</span>
        <span class="n">K_hydro</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="o">=</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">gravity</span> <span class="o">*</span> <span class="p">(</span><span class="n">Awater_main</span> <span class="o">+</span> <span class="n">ncolumn</span><span class="o">*</span><span class="n">Awater_column</span><span class="p">)</span>
        <span class="n">K_hydro</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhoWater</span> <span class="o">*</span> <span class="n">gravity</span> <span class="o">*</span> <span class="n">V_system</span> <span class="o">*</span> <span class="n">h_metacenter</span> <span class="c1"># FAST eqns: (I_waterplane + V_system * z_cb)</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;hydrostatic_stiffness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K_hydro</span>

        <span class="c1"># Now compute all six natural periods at once</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="c1"># Avoids numerical issues</span>
        <span class="n">K_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">K_hydro</span> <span class="o">+</span> <span class="n">K_moor</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;rigid_body_periods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">M_mat</span> <span class="o">+</span> <span class="n">A_mat</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_total</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">check_frequency_margins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">T_sys</span>       <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;rigid_body_periods&#39;</span><span class="p">]</span>
        <span class="n">T_wave_low</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;wave_period_range_low&#39;</span><span class="p">]</span>
        <span class="n">T_wave_high</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;wave_period_range_high&#39;</span><span class="p">]</span>
        <span class="n">f_struct</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;structural_frequencies&#39;</span><span class="p">]</span>
        <span class="n">T_struct</span>    <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">f_struct</span>

        <span class="c1"># Waves cannot excite yaw, so removing that constraint</span>
        
        <span class="c1"># Compute margins between wave forcing and natural periods</span>
        <span class="n">indicator_high</span> <span class="o">=</span> <span class="n">T_wave_high</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T_sys</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">indicator_high</span><span class="p">[</span><span class="n">T_sys</span> <span class="o">&lt;</span> <span class="n">T_wave_low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-16</span>
        <span class="n">indicator_high</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-16</span> <span class="c1"># Not yaw</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;period_margin_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_sys</span> <span class="o">/</span> <span class="n">indicator_high</span>

        <span class="n">indicator_low</span> <span class="o">=</span> <span class="n">T_wave_low</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T_sys</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">indicator_low</span><span class="p">[</span><span class="n">T_sys</span> <span class="o">&gt;</span> <span class="n">T_wave_high</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e30</span>
        <span class="n">indicator_low</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e30</span> <span class="c1"># Not yaw</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;period_margin_low&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T_sys</span> <span class="o">/</span> <span class="n">indicator_low</span>

        <span class="c1"># Compute margins bewteen wave forcing and structural frequencies</span>
        <span class="n">indicator_high</span> <span class="o">=</span> <span class="n">T_wave_high</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T_struct</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">indicator_high</span><span class="p">[</span><span class="n">T_struct</span> <span class="o">&lt;</span> <span class="n">T_wave_low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-16</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;modal_margin_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_struct</span> <span class="o">/</span> <span class="n">indicator_high</span>

        <span class="n">indicator_low</span> <span class="o">=</span> <span class="n">T_wave_low</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T_struct</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">indicator_low</span><span class="p">[</span><span class="n">T_struct</span> <span class="o">&gt;</span> <span class="n">T_wave_high</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e30</span>
        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;modal_margin_low&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T_struct</span> <span class="o">/</span> <span class="n">indicator_low</span>
        
        
    <span class="k">def</span> <span class="nf">compute_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="c1"># Unpack variables</span>
        <span class="n">ncolumn</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;number_of_offset_columns&#39;</span><span class="p">])</span>
        <span class="n">c_mooring</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mooring_cost&#39;</span><span class="p">]</span>
        <span class="n">c_aux</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;offset_cost&#39;</span><span class="p">]</span>
        <span class="n">c_main</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;main_cost&#39;</span><span class="p">]</span>
        <span class="n">c_pontoon</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pontoon_cost&#39;</span><span class="p">]</span>

        <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_mooring</span> <span class="o">+</span> <span class="n">ncolumn</span><span class="o">*</span><span class="n">c_aux</span> <span class="o">+</span> <span class="n">c_main</span> <span class="o">+</span> <span class="n">c_pontoon</span></div>
        

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FloatingSE 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, NREL.
      Last updated on Oct 08, 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>